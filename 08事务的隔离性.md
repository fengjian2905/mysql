# 事务到底是隔离的还是不隔离的？

## 神奇的查询结果

1. 数据准备
   
   ```sql
   CREATE TABLE `t` (
       `id` int(11) NOT NULL,
       `k` int(11) DEFAULT NULL,
       PRIMARY KEY (`id`)
   ) ENGINE=InnoDB;

   insert into t(id,k) values(1,1),(2,2);
   ```

2. 事务A
   
   ```sql
   start transaction with consistent snapshot;
   ```

3. 事务B
   
   ```sql
   start transaction with consistent snapshot;
   ```

4. 事务C
   
   ```sql
   update t set k=k+1 where id=1;
   ```

5. 事务B： 查询结果 **3**
   
   ```sql
   select k from t where id = 1;
   ```

6. 事务A：查询结果 **1**

    ```sql
    select k from t where id=1;
    commit;
    ```

7. 事务B
   
   ```sql
   commit;
   ```

**注意：** 
* begin/start transaction 命令并不是一个事务的起点，在执行它们之后的第一个操作InnoDB表的语句，事务才真正启动； 
* 用`start transaction with consistent snapshot`命令让事务立即启动；

## `快照` 在MVCC里是怎么工作的

> 快照是基于整个库的

一个数据版本，对于一个事务视图来说，除了自己更新的总是可见外，还有三种情况：

1. 版本未提交，不可见
2. 版本已提交，但是是在视图创建后提交的，不可见
3. 版本已提交，而且是在视图创建前提交的，可见

## 更新逻辑的不同

**更新数据都是先读后写的，而这个读，只能读当前的值，称为`当前读`**
