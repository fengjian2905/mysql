# 全局锁和表锁

## 全局锁

1. 定义：对整个数据库加锁

2. 应用场景：全库逻辑备份

3. 加锁方法

* `Flush tables with read lock（FTWRL）`：全库只读  
   
   * 数据更新语句（增删改）阻塞:MDL
   * 数据定义语句（建表、修改表结构）阻塞: DDL
   * 更新类事务提交阻塞
   * 使用 `unlock tables` 命令释放锁
  
   弊端：
   * 主库上备份：备份期间业务停摆
   * 从库备份：备份期间主从同步延迟

* mysqldump 的命令参数--single-transaction，适应所有的表事务引擎的库  
   
   需要引擎支持，MyISAM这种就不支持

* set global readonly=true  **不推荐** !
  
   * readonly通常作他用，比如判断读库还是写库
   * FTWRL在客户端异常断开时，会释放全局锁，而readonly不会  

## 表级锁

> 表级别锁分为表锁和元数据锁
> 
* 加锁
  
```sql
lock tables...read/write
```

* 释放锁
  
```sql
unlock tables 
```

* 客户端断开连接的时候会自动释放

线程A有命令`lock tables t1 read,t2 write`，则t1、t2：

|-|读t1|读t2|写t1|写t2|
|--------|----|----|---|----|
|其他线程|ok|阻塞|阻塞|阻塞|
|线程A|ok|ok|阻塞|ok |

### MDL锁（metadata lock）

> 访问一张表的时候，自动加上，用以保证表结构跟查询之间的一致性，
> 防止DDL和DML并发冲突,
> msyql5.5及以上版本

1. MDL 读锁不互斥，多个线程增删改查同一张表是没问题的
2. 读写锁之间、写锁直接互斥，线程阻塞

## 给一个小表加字段，导致整个数据库挂了？

 <img src="/images/IMG_0940.JPG width = "300" height = "200" alt="图片名称" align=center />

